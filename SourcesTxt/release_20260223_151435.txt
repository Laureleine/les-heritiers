#!/bin/bash
# release.sh - Automatise prebuild + SourcesTxt + git commit + AUTO-PULL

set -e  # Arr√™te sur erreur

echo "üöÄ D√©but du release intelligent..."

# 1. AUTO-PULL avec merge message automatique
echo "üîÑ Auto-pull origin main (backups GitHub Actions)..."
git -c core.editor=true pull origin main 2>/dev/null || \
git -c core.editor=true pull --rebase origin main
echo "‚úÖ Sync GitHub OK"

# 2. SOURCES TXT - Copie fichiers MODIFI√âS (CORRIG√â)
echo "üìù Archivage fichiers modifi√©s ‚Üí SourcesTxt/"
MODIFIED_FILES=$(git diff --name-only HEAD || git status --porcelain | cut -c4- | sort -u)
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

mkdir -p SourcesTxt

# Copie chaque fichier modifi√© ‚Üí SourcesTxt/nomfichier_TIMESTAMP.txt
echo "$MODIFIED_FILES" | while read -r file; do
  if [ -f "$file" ]; then
    FILENAME=$(basename "$file" | sed 's/\.[^.]*$//')  # Enl√®ve extension
    cp "$file" "SourcesTxt/${FILENAME}_${TIMESTAMP}.txt"
    echo "  üìÑ $file ‚Üí SourcesTxt/${FILENAME}_${TIMESTAMP}.txt"
  fi
done

echo "‚úÖ $(echo "$MODIFIED_FILES" | grep -c .) fichiers archiv√©s"

# 3. Ex√©cute prebuild et capture la sortie
BUILD_OUTPUT=$(npm run prebuild 2>&1)
echo "$BUILD_OUTPUT"

# 4. Extrait la version (REGEX CORRIG√âE)
VERSION=$(echo "$BUILD_OUTPUT" | grep -oP 'v\K[0-9]+\.[0-9]+\.[0-9]+' || echo "UNKNOWN")

if [ "$VERSION" = "UNKNOWN" ]; then
  echo "‚ùå Erreur : version non trouv√©e dans le log prebuild"
  exit 1
fi

echo "üì¶ Version d√©tect√©e : v$VERSION"

# 5. Git add des fichiers modifi√©s (scripts + SourcesTxt)
git add .

# 6. Commit avec message format√©
git commit -m "Les H√©ritiers v$VERSION

SourcesTxt archiv√©s ($(echo "$MODIFIED_FILES" | grep -c .) fichiers):
$(echo "$MODIFIED_FILES" | tr '\n' ', ' | sed 's/,$//')"

# 7. Push final
git push -u origin main

echo "‚úÖ Release termin√© : v$VERSION + SourcesTxt"
echo "üíæ Backups GitHub Actions pr√©serv√©s !"
