name: Daily Supabase Backup
on:
  schedule:
    - cron: '0 2 * * *'  # 2h UTC quotidien
  workflow_dispatch:    # Manuel

jobs:
  backup:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
    steps:
      - uses: actions/checkout@v4
      
      - name: DEBUG Secret Injection
        run: |
          echo "üîç Secret length: ${#SUPABASE_DB_URL}"
          echo "üîç Secret preview: ${SUPABASE_DB_URL:0:30}..."
          echo "üîç Full URL length: ${#SUPABASE_DB_URL}"
          if [ -z "$SUPABASE_DB_URL" ]; then
            echo "‚ùå SECRET VIDE - Probl√®me GitHub Secrets !"
            exit 1
          else
            echo "‚úÖ SECRET OK - Passage √† pg_dump"
          fi
      
      - name: Install pg_dump
        run: sudo apt-get update && sudo apt-get install -y postgresql-client
      
      - name: Parse et Backup (TCP forc√©)
        run: |
          mkdir -p backups
          
          # Parse URL avec debug complet
          FULL_URL="$SUPABASE_DB_URL"
          echo "üìã URL compl√®te d√©tect√©e: ${FULL_URL//?*/}"
          
          USER=$(echo "$FULL_URL" | sed -E 's/postgresql:\/\/([^:]+):.*/\1/')
          PASS=$(echo "$FULL_URL" | sed -E 's/.*:([^@]*)@.*/\1/')
          HOST=$(echo "$FULL_URL" | sed -E 's/.*@([^:\/]+).*/\1/')
          PORT=$(echo "$FULL_URL" | sed -E 's/.*:([0-9]+)\/.*/\1/')
          DB=$(echo "$FULL_URL" | sed -E 's/.*\/([^?]*).*/\1/')
          
          echo "üë§ USER: '$USER'"
          echo "üîê PASS: '${PASS:0:3}...'"
          echo "üåê HOST: '$HOST'"
          echo "üîå PORT: '$PORT'"
          echo "üìä DB:   '$DB'"
          
          # Test connexion
          export PGPASSWORD="$PASS"
          echo "üß™ Test pg_dump vers $HOST:$PORT..."
          
          pg_dump \
            -h "$HOST" \
            -p "$PORT" \
            -U "$USER" \
            -d "$DB" \
            --no-owner \
            --no-privileges \
            --disable-triggers \
            -Fc \
            -f "backups/backup_$(date +%Y%m%d_%H%M%S).dump"
            
          echo "‚úÖ Backup cr√©√© !"
          
      - name: V√©rifier fichiers
        run: ls -la backups/
        if: always()
        
      - name: Commit backup
        if: hashFiles('backups/*.dump') != ''
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ü§ñ Backup Supabase $(date +%Y-%m-%d %H:%M)"
          file_pattern: backups/*
